{% extends 'layouts2/main.html' %}
{% load pos_tags %}
{% block content %}
<h4 class="mb-4">ðŸ§¾ Unprinted Sale Log (Grouped by Session)</h4>

{% for session_id, rows in session_logs %}
<div class="row">
  <div class="col-lg-12">
    <div class="card mb-4">
      <div class="card-body">

        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">
            ðŸ—‚ Session: <code>{{ session_id }}</code> &mdash; ðŸ‘¤ User: <strong>{{ rows.0.user.username }}</strong>
          </h5>
          <form method="post" action="{% url 'mark_session_printed' %}" class="d-inline-block">
            {% csrf_token %}
            <input type="hidden" name="session_id" value="{{ session_id }}">
            <button class="btn btn-sm btn-danger" onclick="return confirm('Mark this session as printed?')">
              âœ… Mark Printed
            </button>
          </form>
        </div>

        <table class="table table-striped table-bordered table-sm align-middle">
<thead class="table-dark text-center">
  <tr>
    <th>#</th>
    <th>Row</th>  {# âœ… This is actual POS row number from DB #}
    <th>Inventory</th>
    <th>Qty</th>
    <th>Unit</th>
    <th>Price</th>
    <th>Discount</th>
    <th>Visible</th>
    <th>Created</th>
  </tr>
</thead>
<tbody>
  {% for row in rows %}
  <tr class="text-center">
    <td>{{ forloop.counter }}</td>
<td>
  <a href="#" class="row-log-link text-primary fw-bold"
     data-session="{{ row.session_id }}"
     data-row="{{ row.row_number }}"
     data-bs-toggle="modal"
     data-bs-target="#logModal">
    {{ row.row_number }}
  </a>
</td>
    <td>{{ row.inventory.inventory_name }} {{ row.stock.barcode }} {{ row.stock.pre_barcode }}</td>
    <td>{{ row.qty }}</td>
    <td>{{ row.unit }}</td>
    <td>{{ row.sale_price }}</td>
    <td>{{ row.discount }}</td>
<td>{{ row.visible_duration|visible_duration_human }}</td>
    <td>{{ row.created_at|date:"d/m/Y h:i:s A" }}</td>
  </tr>
  {% endfor %}
</tbody>

        </table>

      </div>
    </div>
  </div>
</div>
{% empty %}
<div class="text-center text-muted">
  âœ… All printed â€” no unprinted sale entries found.
</div>
{% endfor %}

<div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logModalLabel">Row Activity Log</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered table-sm">
          <thead>
            <tr class="table-secondary text-center">
              <th>Time</th>
              <th>User</th>
              <th>Field</th>
              <th>Old Value</th>
              <th>New Value</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="logTableBody" class="text-center">
            <tr><td colspan="6" class="text-muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% endblock %}


{% block footer %}

<script>
$(document).on("click", ".row-log-link", function () {
    const sessionId = $(this).data("session");
    const rowNumber = $(this).data("row");

    $("#logModalLabel").text(`Row ${rowNumber} â€“ Session ${sessionId}`);
    $("#logTableBody").html(`<tr><td colspan="6" class="text-muted">Loading...</td></tr>`);

    fetch("{% url 'get_field_logs' %}?session_id=" + sessionId + "&row_number=" + rowNumber)
    .then(res => res.json())
    .then(data => {
        if (data.logs.length === 0) {
            $("#logTableBody").html(`<tr><td colspan="6" class="text-muted">No changes tracked.</td></tr>`);
            return;
        }

        let rows = "";
        data.logs.forEach(log => {
            rows += `
            <tr>
              <td>${log.timestamp}</td>
              <td>${log.user}</td>
              <td>${log.field}</td>
              <td>${log.old_value}</td>
              <td>${log.new_value}</td>
              <td>${log.action}</td>
            </tr>`;
        });
        $("#logTableBody").html(rows);
    });
});
</script>
{% endblock footer %}